---
title: "Simulating 2020 Using Markets"
output:
  github_document: 
    df_print: tibble
    toc: true
    toc_dept: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, purl=FALSE}
library(knitr)
opts_chunk$set(
  eval = TRUE,
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  comment = "#>",
  fig.path = "../plots/",
  fig.width = 10,
  dpi = 300
)
options(width = 99)
set.seed(seed = 05)
```

Election prediction helps party officials, campaign operatives, and journalists interpret
campaigns in a quantitative manner. Uncertainty is key to a useful election prediction.

The forecast model has become a staple of political punditry. Popularized by the data journalist
at FiveThirtyEight, the forecasting model is a statistical tool used to incorporate a number of
quantitative inputs and produce a _probabilistic_ view of all possible outcomes.

Prediction markets can be used to generate similarly probabilistic views of election outcomes by
utilizing the economic forces of price discovery and risk aversion to overcome the ideological
bias of self-interested traders on a binary options exchange.

Can we possibly use these prediction markets to generate a useful probabalistic simulation of the
electoral college? We'll try and use data from the PredictIt exchange and R code to answer this
question.


```{r packages, warning=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load_current_gh("kiernann/campfin")
pacman::p_load(
  tidyverse,
  jsonlite,
  magrittr,
  janitor,
  rvest,
  usmap
)
```

## Market Data

PredictIt hosts markets for most of the contenious battleground states. We can scrape these
markets using their API and the `jsonlite` package.

```{r}
api_url <- "https://www.predictit.org/api/marketdata/all/"
market_title <- "Which party will win (.*) in the 2020 presidential election?"
ec_markets <-
  fromJSON(txt = api_url) %>%
  use_series(markets) %>%
  filter(name %>% str_detect(market_title)) %>%
  unnest(contracts, names_repair = make_clean_names) %>%
  filter(short_name_2 == "Democratic") %>%
  select(state = short_name, price = last_close_price) %>%
  mutate(state = str_extract(state, "[:upper:]{2}")) %>% 
  arrange(price)
```

```{r markets_map, echo=FALSE}
usa_map <- map_data("state") %>% mutate(state = abrev_state(region))
states_ec_map <- left_join(x = usa_map, y = ec_markets)
states_ec_map %>%
  ggplot(mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", mapping = aes(fill = price)) +
  coord_quickmap() +
  scale_fill_distiller(
    type = "div", 
    palette = "RdBu", 
    direction = -1,
    labels = scales::dollar
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  ggtitle("2020 Electoral College According to Prediction Markets")
```

## Historical Data

To generate a full probabalistic view of the election, we'll need to calculate probabilities for
those states for which there is not a market. It's incredibly reductive, but I'll use 2016 data
normally distributed with a standard deviation of `0.10`. To make things simple, we will ignore
Maine and Nebraska's congressional district apportionment. 

```{r}
past_results <-
  read_html("https://en.wikipedia.org/wiki/2016_United_States_presidential_election") %>%
  html_node("table.wikitable:nth-child(1)") %>%
  html_table(fill = TRUE) %>%
  na_if("â€“") %>%
  as_tibble(.name_repair = "unique") %>%
  select(1, 4, 5, 8) %>%
  slice(-1, -58, -59) %>%
  set_names(c("state", "dem", "dem_votes", "rep_votes")) %>%
  map_dfc(parse_guess) %>% 
  mutate(
    votes = coalesce(dem_votes, rep_votes),
    dem = parse_double(str_remove(dem, "%"))/100,
    state = state %>% 
      str_remove("\\(at-lg\\)") %>% 
      str_remove(",\\s\\d..$") %>% 
      abrev_state()
  ) %>% 
  group_by(state) %>% 
  summarize(
    dem = mean(dem),
    votes = sum(votes)
  )
```

```{r markets_map, echo=FALSE}
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
states_2016_map <- left_join(x = usa_map, y = past_results)
states_2016_map %>%
  mutate(dem = range01(dem)) %>% 
  ggplot(mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", mapping = aes(fill = dem)) +
  coord_quickmap() +
  scale_fill_distiller(
    type = "div", 
    palette = "RdBu", 
    direction = -1,
    labels = scales::dollar
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  ggtitle("2020 Electoral College According to Prediction Markets")
```
